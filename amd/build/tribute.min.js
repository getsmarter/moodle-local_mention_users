define(["jquery"],function(a){"use strict";function b(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},d=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();Array.prototype.find||(Array.prototype.find=function(a){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(b=c[f],a.call(e,b,f,c))return b;return void 0}),function(){function a(a,b){b=b||{bubbles:!1,cancelable:!1,detail:void 0};var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,b.bubbles,b.cancelable,b.detail),c}return"function"==typeof window.CustomEvent?!1:(a.prototype=window.Event.prototype,void(window.CustomEvent=a))}(),!function(){var e=function(){function c(a){var d=this,e=a.values,j=void 0===e?null:e,k=a.iframe,l=void 0===k?null:k,m=a.selectClass,n=void 0===m?"highlight":m,o=a.trigger,p=void 0===o?"@":o,q=a.selectTemplate,r=void 0===q?null:q,s=a.menuItemTemplate,t=void 0===s?null:s,u=a.lookup,v=void 0===u?"key":u,w=a.fillAttr,x=void 0===w?"value":w,y=a.collection,z=void 0===y?null:y,A=a.menuContainer,B=void 0===A?null:A;if(b(this,c),this.menuSelected=0,this.current={},this.inputEvent=!1,this.isActive=!1,this.menuContainer=B,j)this.collection=[{trigger:p,iframe:l,selectClass:n,selectTemplate:(r||c.defaultSelectTemplate).bind(this),menuItemTemplate:(t||c.defaultMenuItemTemplate).bind(this),lookup:v,fillAttr:x,values:j}];else{if(!z)throw new Error("[Tribute] No collection specified.");this.collection=z.map(function(a){return{trigger:a.trigger||p,iframe:a.iframe||l,selectClass:a.selectClass||n,selectTemplate:(a.selectTemplate||c.defaultSelectTemplate).bind(d),menuItemTemplate:(a.menuItemTemplate||c.defaultMenuItemTemplate).bind(d),lookup:a.lookup||v,fillAttr:a.fillAttr||x,values:a.values}})}new h(this),new g(this),new f(this),new i(this)}return d(c,[{key:"triggers",value:function(){return this.collection.map(function(a){return a.trigger})}},{key:"attach",value:function(b){if(!b)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if("undefined"!=typeof a&&b instanceof a&&(b=b.get()),b.constructor===NodeList||b.constructor===HTMLCollection||b.constructor===Array)for(var c=b.length,d=0;c>d;++d)this._attach(b[d]);else this._attach(b)}},{key:"_attach",value:function(a){a.hasAttribute("data-tribute")&&console.warn("Tribute was already bound to "+a.nodeName),this.ensureEditable(a),this.events.bind(a),a.setAttribute("data-tribute",!0)}},{key:"ensureEditable",value:function(a){if(-1===c.inputTypes().indexOf(a.nodeName)){if(!a.contentEditable)throw new Error("[Tribute] Cannot bind to "+a.nodeName);a.contentEditable=!0}}},{key:"createMenu",value:function(){var a=this.range.getDocument().createElement("div"),b=this.range.getDocument().createElement("ul");return a.className="tribute-container",a.appendChild(b),this.menuContainer?this.menuContainer.appendChild(a):this.range.getDocument().body.appendChild(a)}},{key:"showMenuFor",value:function(a,b){var c=this,d=void 0;if(this.menu||(this.menu=this.createMenu(),this.menuEvents.bind(this.menu)),this.isActive=!0,this.menuSelected=0,this.current.mentionText||(this.current.mentionText=""),d=this.search.filter(this.current.mentionText,this.current.collection.values,{pre:"<span>",post:"</span>",extract:function(a){return a[c.current.collection.lookup]}}),this.current.filteredItems=d,!d.length)return void this.hideMenu();var e=this.menu.querySelector("ul");e.innerHTML="",d.forEach(function(a,b){var d=c.range.getDocument().createElement("li");d.setAttribute("data-index",b),c.menuSelected===b&&(d.className=c.current.collection.selectClass),d.innerHTML=c.current.collection.menuItemTemplate(a),e.appendChild(d)}),this.range.positionMenuAtCaret()}},{key:"hideMenu",value:function(){this.menu&&(this.menu.style.cssText="display: none;",this.isActive=!1,this.menuSelected=0,this.current={})}},{key:"selectItemAtIndex",value:function(a){var b=this.current.filteredItems[a],c=this.current.collection.selectTemplate(b);this.replaceText(c)}},{key:"replaceText",value:function(a){this.range.replaceTriggerText(a,!0,!0)}}],[{key:"defaultSelectTemplate",value:function(a){return"@"+a.original[this.current.collection.fillAttr]}},{key:"defaultMenuItemTemplate",value:function(a){return a.string}},{key:"inputTypes",value:function(){return["TEXTAREA","INPUT"]}}]),c}(),f=function(){function a(c){b(this,a),this.tribute=c,this.tribute.menuEvents=this,this.menu=this.tribute.menu}return d(a,[{key:"bind",value:function(a){var b=this;a.addEventListener("keydown",this.tribute.events.keydown.bind(this.menu,this),!1),this.tribute.range.getDocument().addEventListener("click",this.tribute.events.click.bind(null,this),!1),window.addEventListener("resize",this.debounce(function(){b.tribute.isActive&&b.tribute.showMenuFor(b.tribute.current.element)},300,!1))}},{key:"debounce",value:function(a,b,c){var d,e=this,f=arguments;return function(){var g=e,h=f,i=function(){d=null,c||a.apply(g,h)},j=c&&!d;clearTimeout(d),d=setTimeout(i,b),j&&a.apply(g,h)}}}]),a}(),g=function(){function a(c){b(this,a),this.tribute=c,this.tribute.events=this}return d(a,[{key:"bind",value:function(a){a.addEventListener("keydown",this.keydown.bind(a,this),!1),a.addEventListener("keyup",this.keyup.bind(a,this),!1),a.addEventListener("input",this.input.bind(a,this),!1)}},{key:"keydown",value:function(b,c){b.shouldDeactivate(c)&&(b.tribute.isActive=!1);var d=this;b.commandEvent=!1,a.keys().forEach(function(a){a.key===c.keyCode&&(b.commandEvent=!0,b.callbacks()[a.value.toLowerCase()](c,d))})}},{key:"input",value:function(a,b){a.inputEvent=!0,a.keyup.call(this,a,b)}},{key:"click",value:function(a,b){var c=a.tribute;if(c.menu&&c.menu.contains(b.target)){for(var d=b.target;"li"!==d.nodeName.toLowerCase();)if(d=d.parentNode,!d||d===c.menu)throw new Error("cannot find the <li> container for the click");c.selectItemAtIndex(d.getAttribute("data-index")),c.hideMenu()}else c.current.element&&c.hideMenu()}},{key:"keyup",value:function(a,b){var d=this;if(a.inputEvent&&(a.inputEvent=!1),a.updateSelection(this),27!==b.keyCode){if(!a.tribute.isActive){var e=function(){var c=a.getKeyCode(a,d,b);if(isNaN(c))return{v:void 0};var e=a.tribute.triggers().find(function(a){return a.charCodeAt(0)===c});"undefined"!=typeof e&&a.callbacks().triggerChar(b,d,e)}();if("object"===("undefined"==typeof e?"undefined":c(e)))return e.v}a.tribute.current.trigger&&a.commandEvent===!1&&a.tribute.showMenuFor(this)}}},{key:"shouldDeactivate",value:function(b){if(!this.tribute.isActive)return!1;if(0===this.tribute.current.mentionText.length){var c=!1;return a.keys().forEach(function(a){b.keyCode===a.key&&(c=!0)}),!c}return!1}},{key:"getKeyCode",value:function(a,b,c){var d=a.tribute,e=d.range.getTriggerInfo(!1,!1,!0);return e?e.mentionTriggerChar.charCodeAt(0):!1}},{key:"updateSelection",value:function(a){this.tribute.current.element=a;var b=this.tribute.range.getTriggerInfo(!1,!1,!0);b&&(this.tribute.current.selectedPath=b.mentionSelectedPath,this.tribute.current.mentionText=b.mentionText,this.tribute.current.selectedOffset=b.mentionSelectedOffset)}},{key:"callbacks",value:function(){var a=this;return{triggerChar:function(b,c,d){var e=a.tribute;e.current.trigger=d;var f=e.collection.find(function(a){return a.trigger===d});e.current.collection=f,e.showMenuFor(c)},enter:function(b,c){a.tribute.isActive&&(b.preventDefault(),setTimeout(function(){a.tribute.selectItemAtIndex(a.tribute.menuSelected),a.tribute.hideMenu()},0))},escape:function(b,c){a.tribute.isActive&&(b.preventDefault(),a.tribute.hideMenu())},tab:function(b,c){a.callbacks().enter(b,c)},up:function(b,c){if(a.tribute.isActive){b.preventDefault();var d=a.tribute.current.filteredItems.length,e=a.tribute.menuSelected;d>e&&e>0&&(a.tribute.menuSelected--,a.setActiveLi())}},down:function(b,c){if(a.tribute.isActive){b.preventDefault();var d=a.tribute.current.filteredItems.length-1,e=a.tribute.menuSelected;d>e&&(a.tribute.menuSelected++,a.setActiveLi())}}}}},{key:"setActiveLi",value:function(a){for(var b=this.tribute.menu.querySelectorAll("li"),c=b.length>>>0,d=0;c>d;d++){var e=b[d];d===this.tribute.menuSelected?e.className=this.tribute.current.collection.selectClass:e.className=""}}}],[{key:"keys",value:function(){return[{key:9,value:"TAB"},{key:13,value:"ENTER"},{key:27,value:"ESCAPE"},{key:38,value:"UP"},{key:40,value:"DOWN"}]}}]),a}(),h=function(){function a(c){b(this,a),this.tribute=c,this.tribute.range=this}return d(a,[{key:"getDocument",value:function(){var a=void 0;return this.tribute.current.collection&&(a=this.tribute.current.collection.iframe),a?a.contentWindow.document:document}},{key:"positionMenuAtCaret",value:function(){var a=this.tribute.current,b=void 0,c=this.getTriggerInfo(!1,!1,!0);void 0!==c?(b=this.isContentEditable(a.element)?this.getContentEditableCaretPosition(c.mentionPosition):this.getTextAreaOrInputUnderlinePosition(this.getDocument().activeElement,c.mentionPosition),b.top=document.body.scrollTop+b.top,this.tribute.menu.style.cssText="top: "+b.top+"px;\n left: "+b.left+"px;\n position: absolute;\n zIndex: 10000;\n display: block;"):this.tribute.menu.style.cssText="display: none"}},{key:"selectElement",value:function(a,b,c){var d=void 0,e=a;if(b)for(var f=0;f<b.length;f++){if(e=e.childNodes[b[f]],void 0===e)return;for(;e.length<c;)c-=e.length,e=e.nextSibling;0!==e.childNodes.length||e.length||(e=e.previousSibling)}var g=this.getWindowSelection();d=this.getDocument().createRange(),d.setStart(e,c),d.setEnd(e,c),d.collapse(!0);try{g.removeAllRanges()}catch(h){}g.addRange(d),a.focus()}},{key:"resetSelection",value:function(a,b,c){this.isContentEditable(a)?this.selectElement(a,b,c):a!==this.getDocument().activeElement&&a.focus()}},{key:"replaceTriggerText",value:function(a,b,c){var d=this.tribute.current;this.resetSelection(d.element,d.selectedPath,d.selectedOffset);var e=this.getTriggerInfo(b,!0,c),f=new CustomEvent("tribute-replaced",{detail:a});if(void 0!==e){if(this.isContentEditable(d.element))a+=" ",this.pasteHtml(a,e.mentionPosition,e.mentionPosition+e.mentionText.length+1);else{var g=this.getDocument().activeElement;a+=" ";var h=e.mentionPosition,i=e.mentionPosition+e.mentionText.length+1;g.value=g.value.substring(0,h)+a+g.value.substring(i,g.value.length),g.selectionStart=h+a.length,g.selectionEnd=h+a.length}d.element.dispatchEvent(f)}}},{key:"pasteHtml",value:function(a,b,c){var d=void 0,e=void 0;e=this.getWindowSelection(),d=this.getDocument().createRange(),d.setStart(e.anchorNode,b),d.setEnd(e.anchorNode,c),d.deleteContents();var f=this.getDocument().createElement("div");f.innerHTML=a;for(var g=this.getDocument().createDocumentFragment(),h=void 0,i=void 0;h=f.firstChild;)i=g.appendChild(h);d.insertNode(g),i&&(d=d.cloneRange(),d.setStartAfter(i),d.collapse(!0),e.removeAllRanges(),e.addRange(d))}},{key:"getWindowSelection",value:function(){return this.tribute.collection.iframe?this.tribute.collection.iframe.contentWindow.getSelection():window.getSelection()}},{key:"getNodePositionInParent",value:function(a){if(null===a.parentNode)return 0;for(var b=0;b<a.parentNode.childNodes.length;b++){var c=a.parentNode.childNodes[b];if(c===a)return b}}},{key:"getContentEditableSelectedPath",value:function(){var a=this.getWindowSelection(),b=a.anchorNode,c=[],d=void 0;if(null!=b){for(var e=void 0,f=b.contentEditable;null!==b&&"true"!==f;)e=this.getNodePositionInParent(b),c.push(e),b=b.parentNode,null!==b&&(f=b.contentEditable);return c.reverse(),d=a.getRangeAt(0).startOffset,{selected:b,path:c,offset:d}}}},{key:"getTextPrecedingCurrentSelection",value:function(){var a=this.tribute.current,b=void 0;if(this.isContentEditable(a.element)){var c=this.getWindowSelection().anchorNode;if(null!=c){var d=c.textContent,e=this.getWindowSelection().getRangeAt(0).startOffset;e>=0&&(b=d.substring(0,e))}}else{var f=this.getDocument().activeElement,g=f.selectionStart;b=f.value.substring(0,g)}return b}},{key:"getTriggerInfo",value:function(a,b,d){var e=this,f=this.tribute.current,g=void 0,h=void 0,i=void 0;if(this.isContentEditable(f.element)){var j=this.getContentEditableSelectedPath();j&&(g=j.selected,h=j.path,i=j.offset)}else g=this.getDocument().activeElement;var k=this.getTextPrecedingCurrentSelection();if(void 0!==k&&null!==k){var l=function(){var c=-1,f=void 0;if(e.tribute.triggers().forEach(function(a){var b=k.lastIndexOf(a);b>c&&(c=b,f=a)}),c>=0&&(0===c||!d||/[\xA0\s]/g.test(k.substring(c-1,c)))){var j=k.substring(c+1,k.length);f=k.substring(c,c+1);var l=j.substring(0,1),m=j.length>0&&(" "===l||" "===l);if(b&&(j=j.trim()),!m&&(a||!/[\xA0\s]/g.test(j)))return{v:{mentionPosition:c,mentionText:j,mentionSelectedElement:g,mentionSelectedPath:h,mentionSelectedOffset:i,mentionTriggerChar:f}}}}();if("object"===("undefined"==typeof l?"undefined":c(l)))return l.v}}},{key:"isContentEditable",value:function(a){return"INPUT"!==a.nodeName&&"TEXTAREA"!==a.nodeName}},{key:"getTextAreaOrInputUnderlinePosition",value:function(a,b){var c=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],d=null!==window.mozInnerScreenX,e=this.getDocument().createElement("div");e.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(e);var f=e.style,g=window.getComputedStyle?getComputedStyle(a):a.currentStyle;f.whiteSpace="pre-wrap","INPUT"!==a.nodeName&&(f.wordWrap="break-word"),f.position="absolute",f.visibility="hidden",c.forEach(function(a){f[a]=g[a]}),d?(f.width=parseInt(g.width)-2+"px",a.scrollHeight>parseInt(g.height)&&(f.overflowY="scroll")):f.overflow="hidden",e.textContent=a.value.substring(0,b),"INPUT"===a.nodeName&&(e.textContent=e.textContent.replace(/\s/g," "));var h=this.getDocument().createElement("span");h.textContent=a.value.substring(b)||".",e.appendChild(h);var i=a.getBoundingClientRect(),j=document.documentElement,k=(window.pageXOffset||j.scrollLeft)-(j.clientLeft||0),l=(window.pageYOffset||j.scrollTop)-(j.clientTop||0),m={top:i.top+l+h.offsetTop+parseInt(g.borderTopWidth)+parseInt(g.fontSize),left:i.left+k+h.offsetLeft+parseInt(g.borderLeftWidth)};return this.getDocument().body.removeChild(e),m}},{key:"getContentEditableCaretPosition",value:function(a){var b="\ufeff",c=void 0,d="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2),e=void 0,f=this.getWindowSelection(),g=f.getRangeAt(0);e=this.getDocument().createRange(),e.setStart(f.anchorNode,a),e.setEnd(f.anchorNode,a),e.collapse(!1),c=this.getDocument().createElement("span"),c.id=d,c.appendChild(this.getDocument().createTextNode(b)),e.insertNode(c),f.removeAllRanges(),f.addRange(g);var h=c.getBoundingClientRect(),i={left:h.left,top:h.top+c.offsetHeight};return c.parentNode.removeChild(c),i}},{key:"scrollIntoView",value:function(a){for(var b=20,c=void 0,d=100,e=a;void 0===c||0===c.height;)if(c=e.getBoundingClientRect(),0===c.height&&(e=e.childNodes[0],void 0===e||!e.getBoundingClientRect))return;var f=c.top,g=f+c.height;if(0>f)window.scrollTo(0,window.pageYOffset+c.top-b);else if(g>window.innerHeight){var h=window.pageYOffset+c.top-b;h-window.pageYOffset>d&&(h=window.pageYOffset+d);var i=window.pageYOffset-(window.innerHeight-g);i>h&&(i=h)}}}]),a}(),i=function(){function a(c){b(this,a),this.tribute=c,this.tribute.search=this}return d(a,[{key:"simpleFilter",value:function(a,b){var c=this;return b.filter(function(b){return c.test(a,b)})}},{key:"test",value:function(a,b){return null!==this.match(a,b)}},{key:"match",value:function(a,b,c){c=c||{};var d=(b.length,c.pre||""),e=c.post||"",f=c.caseSensitive&&b||b.toLowerCase();a=c.caseSensitive&&a||a.toLowerCase();var g=this.traverse(f,a,0,0,[]);return g?{rendered:this.render(b,g.cache,d,e),score:g.score}:null}},{key:"traverse",value:function(a,b,c,d,e){if(b.length===d)return{score:this.calculateScore(e),cache:e.slice()};if(a.length===c||b.length-d>a.length-c)return void 0;for(var f=b[d],g=a.indexOf(f,c),h=void 0,i=void 0;g>-1;){if(e.push(g),i=this.traverse(a,b,g+1,d+1,e),e.pop(),!i)return h;(!h||h.score<i.score)&&(h=i),g=a.indexOf(f,g+1)}return h}},{key:"calculateScore",value:function(a){var b=0,c=1;return a.forEach(function(d,e){e>0&&(a[e-1]+1===d?c+=c+1:c=1),b+=c}),b}},{key:"render",value:function(a,b,c,d){var e=a.substring(0,b[0]);return b.forEach(function(f,g){e+=c+a[f]+d+a.substring(f+1,b[g+1]?b[g+1]:a.length)}),e}},{key:"filter",value:function(a,b,c){var d=this;return c=c||{},b.reduce(function(b,e,f,g){var h=e;c.extract&&(h=c.extract(e),h||(h=""));var i=d.match(a,h,c);return null!=i&&(b[b.length]={string:i.rendered,score:i.score,index:f,original:e}),b},[]).sort(function(a,b){var c=b.score-a.score;return c?c:a.index-b.index})}}]),a}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=e:window.Tribute=e}()});