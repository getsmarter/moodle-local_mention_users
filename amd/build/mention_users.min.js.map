{"version":3,"sources":["../src/mention_users.js"],"names":["define","$","ajax","init","reply_id","val","length","forum_id","test","window","location","href","advanced_forum","getUsers","replyId","forumId","new_discussion","pathname","indexOf","mentionUsers","call","methodname","args","action","reply","forum","advancedforum","newdiscussion","done","response","result","populateTributeArray","content","courseid","fail","ex","data","JSON","parse","users_array","i","push","key","value","tribute","Tribute","collection","selectTemplate","item","origin","original","values","tributeinstance","usersarray","user","userid","search","match","useridpassed","windowhashash","hash","filter","addEventListener","setTimeout","empty","document","getElementById","ready","attach","fn","time","t","arguments","ctx","clearTimeout","apply","attr","querySelectorAll","append","get","scrollIntoView","shiftWindow","scrollBy"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Version details\n *\n * @package    local_mention_users\n * @copyright  2014 GetSmarter {@link http://www.getsmarter.co.za}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module local_mention_users/mention\n */\n\ndefine(['jquery', 'core/ajax', 'local_mention_users/tribute'], function($, ajax) {\n\n  var module = {};\n\n  module.init = function() {\n\n    var reply_id = $('input[name=reply]').val();\n    if ($('input[name=forum]').length > 0) {\n      var forum_id = $('input[name=forum]').val();\n    }else{\n      var forum_id = 0;\n    }\n\n    if (/hsuforum/.test(window.location.href)) {\n      var advanced_forum = 1;\n    } else {\n      var advanced_forum = 0;\n    }\n\n    function getUsers(replyId, forumId, advanced_forum) {\n      var new_discussion = window.location.pathname.indexOf(\"/mod/hsuforum/view.php\") > -1;\n\n        var mentionUsers = ajax.call([\n            {\n                methodname: 'local_mention_users_getusers',\n                args: {\n                    action: 'tribute',\n                    reply: replyId,\n                    forum: forumId,\n                    advancedforum: advanced_forum,\n                    newdiscussion: new_discussion\n                }\n            }\n        ]);\n\n        mentionUsers[0].done(function(response) {\n            if (response.result) {\n                populateTributeArray(response.content, response.courseid);\n            } else {\n                throw response.content;\n            }\n        }).fail(function(ex) {\n            throw ex;\n        });\n    }\n\n    function populateTributeArray(content, courseid) {\n      var data = JSON.parse(content);\n      var users_array = [];\n\n      for (i = 0; i < data.length; i += 2) {\n        users_array.push({\n          key: data[i],\n          value: data[i + 1]\n        });\n      }\n\n      var tribute = new Tribute({\n        collection: [{\n          selectTemplate: function(item) {\n            return '<span contenteditable=\"false\"><a href=' + window.location.origin + '/user/view.php?id=' + item.original.value + '&course=' + courseid + ' target=\"_blank\" userid=\"' + item.original.value + '\">@' + item.original.key + '</a></span>';\n          },\n          values: users_array\n        }]\n      })\n\n      window.tributeinstance = tribute;\n      window.usersarray = users_array;\n\n      let user = null;\n      let userid = window.location.search.match(/u=(\\d+)/);\n      let useridpassed = false;\n      let windowhashash = false;\n      if (userid !== null) {\n        // This is a bit hacky, but if a user has the auto-tag functionality, once they submit, it retags user, so if\n        // there is the hash (which is added to scroll to the post), don't allow aut-tagging\n        useridpassed = true;\n        windowhashash = window.location.hash !== '';\n        user = users_array.filter(function(item) {return item.value == userid[1]})[0];\n        window.addEventListener('hashchange', function() {\n          setTimeout(function() {\n            if (userid)\n            $('.hsuforum-textarea').empty();\n            $('#hiddenadvancededitoreditable').empty();\n          }, 1000);\n        });\n      }\n\n      // Atto Editor\n      if (document.getElementById('id_messageeditable')) {\n        $(document).ready(function() {\n          tribute.attach(document.getElementById('id_messageeditable'));\n        });\n      }\n\n      //Advanced forum\n      document.addEventListener(\"DOMSubtreeModified\", throttle( function() {\n        if (!$('.hsuforum-textarea').attr('data-tribute')) {\n          tribute.attach(document.querySelectorAll('.hsuforum-textarea'));\n        }\n        if (!$('#hiddenadvancededitoreditable').attr('data-tribute')) {\n          tribute.attach(document.querySelectorAll('#hiddenadvancededitoreditable'));\n          if (useridpassed && !windowhashash){\n            $('.hsuforum-textarea').append(\n              '<span contenteditable=\"false\"><a href=' + window.location.origin + '/user/view.php?id=' + user.value + '&course=' + courseid + ' target=\"_blank\" userid=\"' + user.value + '\">@' + user.key + '</a></span>&nbsp;'\n            );\n            $('.hsuforum-textarea').get(0).scrollIntoView();\n          } else if (useridpassed && windowhashash) {\n            $('.hsuforum-textarea').empty();\n          }\n        }\n        if (!$('#hiddenadvancededitoreditable').attr('data-tribute')) {\n          tribute.attach(document.querySelectorAll('#hiddenadvancededitoreditable'));\n          if (useridpassed && !windowhashash){\n            $('#hiddenadvancededitoreditable').append(\n              '<span contenteditable=\"false\"><a href=' + window.location.origin + '/user/view.php?id=' + user.value + '&course=' + courseid + ' target=\"_blank\" userid=\"' + user.value + '\">@' + user.key + '</a></span>&nbsp;'\n            )\n            $('#hiddenadvancededitoreditable').get(0).scrollIntoView();\n          } else if (useridpassed && windowhashash) {\n            $('#hiddenadvancededitoreditable').empty();\n          }\n        }\n      }, 50 ), false );\n\n      // This is to ensure that the DOMSubtreeModified event doesn't execute our code over and over.\n      // http://stackoverflow.com/questions/11867331/how-to-identify-that-last-domsubtreemodified-is-fired\n      function throttle( fn, time ) {\n          var t = 0;\n          return function() {\n              var args = arguments,\n                  ctx = this;\n\n                  clearTimeout(t);\n\n              t = setTimeout( function() {\n                  fn.apply( ctx, args );\n              }, time );\n          };\n      }\n    }\n\n    // Anchor links offset because hanging navbar hides half the post by default\n    var shiftWindow = function() { scrollBy(0, -70) };\n    if (location.hash) shiftWindow();\n    window.addEventListener(\"hashchange\", shiftWindow);\n    getUsers(reply_id, forum_id, advanced_forum);\n  };\n  return module;\n});\n"],"file":"mention_users.min.js"}