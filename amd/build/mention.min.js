define(["jquery"],function(a){!function(a){a.fn.extend({mention:function(b){this.opts={users:[],delimiter:"@",sensitive:!0,emptyQuery:!1,queryBy:["name","username"],typeaheadOpts:{}};var c=a.extend({},this.opts,b),d=function(){if("undefined"==typeof a)throw new Error("jQuery is Required");if("undefined"==typeof a.fn.typeahead)throw new Error("Typeahead is Required");return!0},e=function(a,b){var d;for(d=b;d>=0&&a[d]!=c.delimiter;d--);return a.substring(d,b)},f=function(a){var b;if(c.emptyQuery){var d=this.query.toLowerCase(),e=this.$element[0].selectionStart,f=d.slice(e-1,e);if(f==c.delimiter)return!0}for(b in c.queryBy)if(a[c.queryBy[b]]){var g,h=a[c.queryBy[b]].toLowerCase(),i=this.query.toLowerCase().match(new RegExp(c.delimiter+"\\w+","g"));if(i)for(g=0;g<i.length;g++){var j=i[g].substring(1).toLowerCase(),k=new RegExp(c.delimiter+h,"g"),l=this.query.toLowerCase().match(k);if(-1!=h.indexOf(j)&&null===l)return!0}}},g=function(a){var b,d=this.query,e=this.$element[0].selectionStart;for(b=e;b>=0&&d[b]!=c.delimiter;b--);var f=(d.substring(b,e),d.substring(0,b)),g=d.substring(e),d=f+c.delimiter+a+g;return this.tempQuery=d,d},h=function(a){if(a.length&&c.sensitive){var b,d=e(this.query,this.$element[0].selectionStart).substring(1),f=a.length,g={highest:[],high:[],med:[],low:[]},h=[];if(1==d.length){for(b=0;f>b;b++){var i=a[b];i.username[0]==d?g.highest.push(i):i.username[0].toLowerCase()==d.toLowerCase()?g.high.push(i):-1!=i.username.indexOf(d)?g.med.push(i):g.low.push(i)}for(b in g){var j;for(j in g[b])h.push(g[b][j])}return h}}return a},i=function(b){var d=this;return b=a(b).map(function(b,e){b=a(d.options.item).attr("data-value",e.username);var f=a("<div />");return e.image&&f.append('<img class="mention_image" src="'+e.image+'">'),e.name&&f.append('<b class="mention_name">'+e.name+"</b>"),e.username&&f.append('<span class="mention_username"> '+c.delimiter+e.username+"</span>"),b.find("a").html(d.highlighter(f.html())),b[0]}),b.first().addClass("active"),this.$menu.html(b),this};return a.fn.typeahead.Constructor.prototype.render=i,this.each(function(){var b=a(this);d()&&b.typeahead(a.extend({source:c.users,matcher:f,updater:g,sorter:h},c.typeaheadOpts))})}})}(a)});